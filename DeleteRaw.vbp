Private Sub Worksheet_Change(ByVal Target As Range)
    Dim ws As Worksheet
    Dim colStart As Long, colEnd As Long
    Dim matchAll As Boolean
    Dim c As Long
    
    Set ws = Me
    
    ' –î–∏–∞–ø–∞–∑–æ–Ω, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–æ–≤–µ—Ä—è–µ–º (B:H) –∏ —Ç–æ–ª—å–∫–æ —Å—Ç—Ä–æ–∫–∞ 4
    colStart = 2  ' B
    colEnd = 8    ' H
    
    ' –ï—Å–ª–∏ –∏–∑–º–µ–Ω–µ–Ω–∏—è –Ω–µ –∑–∞—Ç—Ä–∞–≥–∏–≤–∞—é—Ç B4:H4 ‚Äî –≤—ã—Ö–æ–¥–∏–º
    If Intersect(Target, ws.Range(ws.Cells(4, colStart), ws.Cells(4, colEnd))) Is Nothing Then Exit Sub
    
    Application.EnableEvents = False
    
    ' –ü—Ä–æ–≤–µ—Ä–∫–∞: –≤—Å–µ –ª–∏ –∑–Ω–∞—á–µ–Ω–∏—è —Ä–∞–≤–Ω—ã –∑–Ω–∞—á–µ–Ω–∏—è–º –≤ —Å—Ç—Ä–æ–∫–µ 3 –∏ —è–≤–ª—è—é—Ç—Å—è —Ç–µ–∫—Å—Ç–æ–º
    matchAll = True
    For c = colStart To colEnd
        If ws.Cells(4, c).Value <> ws.Cells(3, c).Value Or _
           VarType(ws.Cells(4, c).Value) <> vbString Then
            matchAll = False
            Exit For
        End If
    Next c
    
    ' –ï—Å–ª–∏ –≤—Å—ë —Å–æ–≤–ø–∞–¥–∞–µ—Ç ‚Äî —É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É 4 (—Å–¥–≤–∏–≥–∞–µ–º –≤—Å—ë –≤—ã—à–µ)
    If matchAll Then
        ws.Range(ws.Cells(4, colStart), ws.Cells(4, colEnd)).Delete Shift:=xlUp
    End If
    
    Application.EnableEvents = True
End Sub



////


Private Sub Worksheet_Change(ByVal Target As Range)
    Dim checkRange As Range, cell As Range
    Dim col As Long, lastRow As Long
    
    ' –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É –≤ —Å—Ç–æ–ª–±—Ü–µ B
    lastRow = Me.Cells(Me.Rows.Count, "B").End(xlUp).Row
    If lastRow < 4 Then lastRow = 4
    
    ' –î–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (B:M, –Ω–∞—á–∏–Ω–∞—è —Å 4-–π —Å—Ç—Ä–æ–∫–∏)
    Set checkRange = Me.Range("B4:M" & lastRow)
    
    ' –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ —á—Ç–æ-—Ç–æ –≤ –Ω–∞—à–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
    If Not Intersect(Target, checkRange) Is Nothing Then
        
        Application.EnableEvents = False
        
        Dim rowNum As Long
        For rowNum = lastRow To 4 Step -1
            Dim matchAll As Boolean
            matchAll = True
            
            ' –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–≤–Ω—ã –ª–∏ –≤—Å–µ —è—á–µ–π–∫–∏ –≤ —Å—Ç—Ä–æ–∫–µ –∑–Ω–∞—á–µ–Ω–∏—è–º –≤ —Å—Ç—Ä–æ–∫–µ 3
            For col = 2 To 13 ' B=2, M=13
                If CStr(Me.Cells(rowNum, col).Value) <> CStr(Me.Cells(3, col).Value) Then
                    matchAll = False
                    Exit For
                End If
            Next col
            
            ' –ï—Å–ª–∏ –≤—Å–µ —Å–æ–≤–ø–∞–ª–∏ ‚Äî —É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
            If matchAll Then
                Me.Rows(rowNum).Delete Shift:=xlUp
            End If
        Next rowNum
        
        ' –û–±–Ω–æ–≤–ª—è–µ–º lastRow –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫
        lastRow = Me.Cells(Me.Rows.Count, "B").End(xlUp).Row
        If lastRow < 4 Then lastRow = 4
        
        ' –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É –≤–æ –≤—Å–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ B:M
        Me.Range("B4:M" & lastRow).HorizontalAlignment = xlCenter
        Me.Range("B4:M" & lastRow).VerticalAlignment = xlCenter
        
        ' –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤
        Me.Columns("B:M").AutoFit
        
        ' –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ 3-–π —Å—Ç—Ä–æ–∫–µ (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ —É–±—Ä–∞–ª–∏—Å—å)
        If Not Me.AutoFilterMode Then
            Me.Range("B3:M3").AutoFilter
        End If
        
        Application.EnableEvents = True
    End If
End Sub

------------------


' --- –î–æ–±–∞–≤–ª—è–µ–º —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É –ø–æ —Å—Ç–æ–ª–±—Ü—É C (3-–π —Å—Ç–æ–ª–±–µ—Ü) ---
With Me.Sort
    .SortFields.Clear
    .SortFields.Add Key:=Me.Range("C4:C" & lastRow), _
        SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
    .SetRange Me.Range("B3:M" & lastRow)
    .Header = xlYes
    .MatchCase = False
    .Orientation = xlTopToBottom
    .Apply
End With
' --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–∫–∏ ---



----------------


–≠—Ç–æ –¥–æ–±–∞–≤–∏–º –≤ —Ç–≤–æ–π –æ–±—Ä–∞–±–æ—Ç—á–∏–∫ Worksheet_Change, 
–ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫ –∏ –ø–µ—Ä–µ–¥ 
–≤—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ–º –∏ –∞–≤—Ç–æ—Ñ–∏—Ç–æ–º:



' --- –ù–∞—á–∞–ª–æ –¥–æ–±–∞–≤–∫–∏ –¥–ª—è —Å—Ç–æ–ª–±—Ü–∞ –û ---
Dim valM As Variant
For rowNum = 4 To lastRow
    valM = Me.Cells(rowNum, "M").Value
    If IsNumeric(valM) Then
        If valM = 0 Then
            Me.Cells(rowNum, "O").Value = "Customer"
        Else
            Me.Cells(rowNum, "O").Value = "FTD"
        End If
    Else
        Me.Cells(rowNum, "O").Value = "" ' –û—á–∏—â–∞–µ–º –µ—Å–ª–∏ –Ω–µ —á–∏—Å–ª–æ
    End If
Next rowNum
' --- –ö–æ–Ω–µ—Ü –¥–æ–±–∞–≤–∫–∏ ---


—É–Ω–æ–ø–∫–∞ –æ—á–∏—Å—Ç–∫–∏ 

Sub ClearAndReset()
    Dim ws As Worksheet
    Dim col As Long
    Dim defaultWidths() As Double
    Set ws = ThisWorkbook.Sheets("Sheet1") ' <-- –∑–∞–º–µ–Ω–∏ –Ω–∞ –∏–º—è —Å–≤–æ–µ–≥–æ –ª–∏—Å—Ç–∞
    
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    
    ' –û—á–∏—Å—Ç–∫–∞ –∑–Ω–∞—á–µ–Ω–∏–π —Å B4 –ø–æ N –¥–æ –ø–æ—Å–ª–µ–¥–Ω–µ–π —Å—Ç—Ä–æ–∫–∏ —Å –¥–∞–Ω–Ω—ã–º–∏
    Dim lastRow As Long
    lastRow = ws.Cells(ws.Rows.Count, "B").End(xlUp).Row
    If lastRow < 4 Then lastRow = 4
    ws.Range("B4:N" & lastRow).ClearContents
    
    ' –°–±—Ä–æ—Å —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤ B:N –ø–æ —à–∏—Ä–∏–Ω–µ –∑–∞–≥–æ–ª–æ–≤–∫–æ–≤ –≤ —Å—Ç—Ä–æ–∫–µ 3
    For col = 2 To 14 ' B=2 ... N=14
        ws.Columns(col).ColumnWidth = ws.Range(ws.Cells(3, col), ws.Cells(3, col)).ColumnWidth
    Next col
    
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub



..


–≤—Å—Ç–∞–≤–ª—è–µ—à—å —ç—Ç–æ—Ç –∫—É—Å–æ–∫ –≤ –∫–æ–Ω–µ—Ü —Å–≤–æ–µ–≥–æ –º–∞–∫—Ä–æ—Å–∞, –∫–æ—Ç–æ—Ä—ã–π  –æ—Ç–≤–µ—á–∞–µ—Ç –∑–∞ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫—É.

–ù–∞–ø—Ä–∏–º–µ—Ä, –µ—Å–ª–∏ —É —Ç–µ–±—è –∫–æ–¥ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –∑–∞–∫–∞–Ω—á–∏–≤–∞–µ—Ç—Å—è —á–µ–º-—Ç–æ –≤—Ä–æ–¥–µ:

.SortFields.Clear
.SortFields.Add Key:=Range("C3:C" & LastRow), SortOn:=xlSortOnValues, Order:=xlAscending, DataOption:=xlSortNormal
.SetRange Range("A3:N" & LastRow)
.Header = xlYes
.Apply
End With

–¢–æ —Å—Ä–∞–∑—É –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –±–ª–æ–∫–∞ (–∏ –ø–µ—Ä–µ–¥ End Sub) –¥–æ–±–∞–≤–ª—è–µ—à—å:

Call RemoveEmptyRows

–ê —Å–∞–º—É –ø–æ–¥–ø—Ä–æ–≥—Ä–∞–º–º—É RemoveEmptyRows –≤—Å—Ç–∞–≤–ª—è–µ—à—å –≤ —Ç–æ–º –∂–µ –º–æ–¥—É–ª–µ, –Ω–æ –æ—Ç–¥–µ–ª—å–Ω–æ, –≤–æ—Ç —Ç–∞–∫:

Private Sub RemoveEmptyRows()
    Dim ws As Worksheet
    Dim LastRow As Long
    Dim r As Long
    
    Set ws = Me ' –ï—Å–ª–∏ –∫–æ–¥ –≤ –º–æ–¥—É–ª–µ –ª–∏—Å—Ç–∞
    
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual
    
    LastRow = ws.Cells(ws.Rows.Count, "B").End(xlUp).Row
    
    For r = LastRow To 4 Step -1
        If Application.WorksheetFunction.CountA(ws.Range("B" & r & ":N" & r)) = 0 Then
            ws.Rows(r).Delete
        End If
    Next r
    
    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
End Sub

üìå –ò—Ç–æ–≥:
	‚Ä¢	RemoveEmptyRows –±—É–¥–µ—Ç —É–¥–∞–ª—è—Ç—å –≤—Å–µ –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ B:N.
	‚Ä¢	–ü–æ—Å–ª–µ —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∏ –≤—Å—ë –±—É–¥–µ—Ç –ø–æ–¥—Ç—è–≥–∏–≤–∞—Ç—å—Å—è –≤–≤–µ—Ä—Ö –±–µ–∑ –¥—ã—Ä–æ–∫.
	‚Ä¢	–°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ C (–ê-–Ø) –æ—Å—Ç–∞–Ω–µ—Ç—Å—è –∫–∞–∫ —É —Ç–µ–±—è.–û–∫–µ–π, —Ç–æ–≥–¥–∞ –±–µ—Ä—ë–º –ø–µ—Ä–≤—ã–π —Å–ø–æ—Å–æ–± (—Ñ–æ—Ä–º–∞ UserForm –∫–∞–∫ ‚Äú–ø–ª–∞–≤–∞—é—â–∞—è‚Äù –ø–∞–Ω–µ–ª—å).




–ö–æ–¥ –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è —Ç–∞–∫:

1Ô∏è‚É£ –°–æ–∑–¥–∞—ë–º —Å–∞–º—É –∫–Ω–æ–ø–∫—É –≤ UserForm
	‚Ä¢	–í VBA –∂–º—ë—à—å Insert ‚Üí UserForm.
	‚Ä¢	–î–æ–±–∞–≤–ª—è–µ—à—å —Ç—É–¥–∞ CommandButton (–∫–Ω–æ–ø–∫–∞).
	‚Ä¢	–î–µ–ª–∞–µ—à—å –µ—ë –∫—Ä–∞—Å–∏–≤–æ–π ‚Äî —Ü–≤–µ—Ç, —à—Ä–∏—Ñ—Ç, —Ä–∞–∑–º–µ—Ä.

2Ô∏è‚É£ –ö–æ–¥ –¥–ª—è –∫–Ω–æ–ø–∫–∏ —Å –∏–∑–º–µ–Ω–µ–Ω–∏–µ–º —Ü–≤–µ—Ç–∞ –ø—Ä–∏ –∫–ª–∏–∫–µ ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤ –∫–æ–¥ UserForm:

Private Sub CommandButton1_Click()
    Static toggled As Boolean
    
    If toggled Then
        Me.CommandButton1.BackColor = RGB(0, 176, 240) ' –¶–≤–µ—Ç –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
        Me.CommandButton1.Caption = "–û—á–∏—Å—Ç–∏—Ç—å"
    Else
        Me.CommandButton1.BackColor = RGB(255, 0, 0) ' –¶–≤–µ—Ç –ø—Ä–∏ –∫–ª–∏–∫–µ
        Me.CommandButton1.Caption = "–ì–æ—Ç–æ–≤–æ!"
        ' –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å –º–∞–∫—Ä–æ—Å –æ—á–∏—Å—Ç–∫–∏
        Call ClearAndReset
    End If
    
    toggled = Not toggled
End Sub

3Ô∏è‚É£ –ö–æ–¥ –¥–ª—è –æ—Ç–∫—Ä—ã—Ç–∏—è –ø–∞–Ω–µ–ª–∏ –ø—Ä–∏ –∑–∞–ø—É—Å–∫–µ —Ñ–∞–π–ª–∞ ‚Äî –≤—Å—Ç–∞–≤–ª—è–µ—Ç—Å—è –≤ ThisWorkbook:

Private Sub Workbook_Open()
    UserForm1.Show vbModeless
End Sub

vbModeless ‚Äî –∑–Ω–∞—á–∏—Ç, —á—Ç–æ –æ–∫–Ω–æ –±—É–¥–µ—Ç –≤–∏—Å–µ—Ç—å –Ω–∞–¥ –ª–∏—Å—Ç–æ–º, –∞ —Ç—ã —Å–º–æ–∂–µ—à—å –ø—Ä–æ–¥–æ–ª–∂–∞—Ç—å —Ä–∞–±–æ—Ç–∞—Ç—å –≤ Excel, –∫–∞–∫ –≤ Word —Å –ø–∞–Ω–µ–ª—å—é.

4Ô∏è‚É£ –ö–æ–¥ –º–∞–∫—Ä–æ—Å–∞ –æ—á–∏—Å—Ç–∫–∏ (ClearAndReset) –º–æ–∂–Ω–æ –æ—Å—Ç–∞–≤–∏—Ç—å –≤ –æ–±—ã—á–Ω–æ–º –º–æ–¥—É–ª–µ, —á—Ç–æ–±—ã –æ–Ω –≤—ã–∑—ã–≤–∞–ª—Å—è –ø—Ä–∏ –∫–ª–∏–∫–µ –Ω–∞ –∫–Ω–æ–ø–∫—É.

Private Sub Worksheet_Change(ByVal Target As Range)
    Application.EnableEvents = False
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual

    ' --- —Ç–≤–æ–π —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–π –∫–æ–¥, –Ω–∞–ø—Ä–∏–º–µ—Ä —Å–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞, –ø—Ä–æ–≤–µ—Ä–∫–∏ –∏ —Ç.–¥. ---

    Dim ws As Worksheet
    Dim lastRow As Long
    Dim r As Long
    Set ws = Me

    lastRow = ws.Cells(ws.Rows.Count, "B").End(xlUp).Row
    If lastRow < 4 Then lastRow = 4

    ' –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ —Å–Ω–∏–∑—É –≤–≤–µ—Ä—Ö
    For r = lastRow To 4 Step -1
        If Application.WorksheetFunction.CountA(ws.Range("B" & r & ":N" & r)) = 0 Then
            ws.Rows(r).Delete Shift:=xlUp
        End If
    Next r

    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True
    Application.EnableEvents = True
End Sub





–∫–Ω–æ–ø–∫–∞
–í –ú–û–î–£–õ–¨ 1:
' === Module: Module1 ===
Option Explicit

Public gBackupSheetName As String
Public gOriginalSheetName As String

' –ó–∞–ø—É—Å–∫–∞–µ—Ç—Å—è —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –ª–∏—Å—Ç–∞: Call RemoveEmptyRowsWithUndo(Me)
Public Sub RemoveEmptyRowsWithUndo(ByVal ws As Worksheet)
    Dim lastRow As Long, r As Long
    Dim backupName As String
    Dim bs As Worksheet

    backupName = "__Backup_RemoveEmptyRows"
    On Error Resume Next
    ' –£–¥–∞–ª–∏–º —Å—Ç–∞—Ä—ã–π —Ä–µ–∑–µ—Ä–≤, –µ—Å–ª–∏ –µ—Å—Ç—å
    ThisWorkbook.Worksheets(backupName).Delete
    On Error GoTo 0

    ' –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é —Å—Ç—Ä–æ–∫—É –ø–æ —Å—Ç–æ–ª–±—Ü—É B
    lastRow = ws.Cells(ws.Rows.Count, "B").End(xlUp).Row
    If lastRow < 4 Then lastRow = 4

    ' –°–æ–∑–¥–∞—ë–º —Å–∫—Ä—ã—Ç—ã–π –ª–∏—Å—Ç –¥–ª—è –±—ç–∫–∞–ø–∞ –∏ –∫–æ–ø–∏—Ä—É–µ–º —Ç—É–¥–∞ —Å—Ç—Ä–æ–∫–∏ 3..lastRow (–≤–∫–ª—é—á–∞—è –∑–∞–≥–æ–ª–æ–≤–∫–∏)
    Set bs = ThisWorkbook.Worksheets.Add(After:=ThisWorkbook.Sheets(ThisWorkbook.Sheets.Count))
    bs.Name = backupName
    bs.Visible = xlSheetVeryHidden
    ws.Rows("3:" & lastRow).Copy Destination:=bs.Rows("3")

    ' –ó–∞–ø–æ–º–Ω–∏–º –∏–º–µ–Ω–∞ –¥–ª—è Undo
    gBackupSheetName = backupName
    gOriginalSheetName = ws.Name

    ' –£–¥–∞–ª—è–µ–º –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ B:N (—Å 4-–π —Å—Ç—Ä–æ–∫–∏ –≤–Ω–∏–∑)
    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual

    For r = lastRow To 4 Step -1
        If Application.WorksheetFunction.CountA(ws.Range("B" & r & ":N" & r)) = 0 Then
            ws.Rows(r).Delete Shift:=xlUp
        End If
    Next r

    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True

    ' –ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ–º Undo ‚Äî —ç—Ç–æ –ø–æ–∑–≤–æ–ª–∏—Ç Ctrl+Z –≤—ã–ø–æ–ª–Ω–∏—Ç—å UndoRemoveEmptyRows
    On Error Resume Next
    Application.OnUndo "Undo Remove Empty Rows", "UndoRemoveEmptyRows"
    On Error GoTo 0
End Sub

' –§—É–Ω–∫—Ü–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è (–≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è —á–µ—Ä–µ–∑ Application.OnUndo)
Public Sub UndoRemoveEmptyRows()
    Dim ws As Worksheet, bs As Worksheet
    Dim lastRowBackup As Long, countRows As Long

    If gBackupSheetName = "" Or gOriginalSheetName = "" Then
        MsgBox "–ù–µ—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏ –¥–ª—è –æ—Ç–º–µ–Ω—ã.", vbExclamation
        Exit Sub
    End If

    On Error GoTo ErrHandler
    Set bs = ThisWorkbook.Worksheets(gBackupSheetName)
    Set ws = ThisWorkbook.Worksheets(gOriginalSheetName)

    lastRowBackup = bs.Cells(bs.Rows.Count, "B").End(xlUp).Row
    If lastRowBackup < 3 Then
        MsgBox "–†–µ–∑–µ—Ä–≤ –ø—É—Å—Ç.", vbExclamation
        GoTo Cleanup
    End If

    countRows = lastRowBackup - 3 + 1 ' –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç—Ä–æ–∫ –≤ —Ä–µ–∑–µ—Ä–≤–µ, –Ω–∞—á–∏–Ω–∞—è —Å 3

    Application.ScreenUpdating = False
    Application.Calculation = xlCalculationManual

    ' –£–¥–∞–ª–∏–º —Ç–µ–∫—É—â–∏–µ —Å—Ç—Ä–æ–∫–∏ 3..(3+countRows-1) –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å,
    ' –∑–∞—Ç–µ–º –≤—Å—Ç–∞–≤–∏–º —Ä–µ–∑–µ—Ä–≤ —Å–≤–µ—Ä—Ö—É –Ω–∞—á–∏–Ω–∞—è —Å 3-–π —Å—Ç—Ä–æ–∫–∏
    On Error Resume Next
    ws.Rows("3:" & (3 + countRows - 1)).Delete Shift:=xlUp
    On Error GoTo 0

    bs.Rows("3:" & lastRowBackup).Copy
    ws.Rows("3").Insert Shift:=xlDown

    ' –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π –ª–∏—Å—Ç —Ä–µ–∑–µ—Ä–≤–Ω–æ–π –∫–æ–ø–∏–∏
    Application.DisplayAlerts = False
    bs.Delete
    Application.DisplayAlerts = True

    ' –û—á–∏—Å—Ç–∏–º –≥–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ
    gBackupSheetName = ""
    gOriginalSheetName = ""

    Application.Calculation = xlCalculationAutomatic
    Application.ScreenUpdating = True

Cleanup:
    Exit Sub

ErrHandler:
    MsgBox "–û—à–∏–±–∫–∞ –ø—Ä–∏ –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–∏: " & Err.Description, vbExclamation
    Resume Cleanup
End Sub




–í –õ–ò–°–¢ 1:
–∏–∑–º–µ–Ω–∏—Ç—å 
Call RemoveEmptyRowsWithUndo(Me)' 

–ü–æ–¥—Ç—è–Ω—É—Ç—å –ø—É—Å—Ç—ã–µ —Å—Ç—Ä–æ–∫–∏ –≤–≤–µ—Ä—Ö
On Error Resume Next
Me.Range("B3:N" & Me.Cells(Me.Rows.Count, "B").End(xlUp).Row).SpecialCells(xlCellTypeBlanks).Delete Shift:=xlUp
On Error GoTo 0


Private Sub Worksheet_Change(ByVal Target As Range)
    Dim checkRange As Range, cell As Range
    Dim col As Long, lastRow As Long
    
    ' –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É –≤ —Å—Ç–æ–ª–±—Ü–µ B
    lastRow = Me.Cells(Me.Rows.Count, "B").End(xlUp).Row
    If lastRow < 4 Then lastRow = 4
    
    ' –î–∏–∞–ø–∞–∑–æ–Ω –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ (B:M, –Ω–∞—á–∏–Ω–∞—è —Å 4-–π —Å—Ç—Ä–æ–∫–∏)
    Set checkRange = Me.Range("B4:M" & lastRow)
    
    ' –ï—Å–ª–∏ –∏–∑–º–µ–Ω–∏–ª–∏ —á—Ç–æ-—Ç–æ –≤ –Ω–∞—à–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ
    If Not Intersect(Target, checkRange) Is Nothing Then
        
        Application.EnableEvents = False
        
        Dim rowNum As Long
        For rowNum = lastRow To 4 Step -1
            Dim matchAll As Boolean
            matchAll = True
            
            ' –ü—Ä–æ–≤–µ—Ä—è–µ–º, —Ä–∞–≤–Ω—ã –ª–∏ –≤—Å–µ —è—á–µ–π–∫–∏ –≤ —Å—Ç—Ä–æ–∫–µ –∑–Ω–∞—á–µ–Ω–∏—è–º –≤ —Å—Ç—Ä–æ–∫–µ 3
            For col = 2 To 13 ' B=2, M=13
                If CStr(Me.Cells(rowNum, col).Value) <> CStr(Me.Cells(3, col).Value) Then
                    matchAll = False
                    Exit For
                End If
            Next col
            
            ' –ï—Å–ª–∏ –≤—Å–µ —Å–æ–≤–ø–∞–ª–∏ ‚Äî —É–¥–∞–ª—è–µ–º —Å—Ç—Ä–æ–∫—É
            If matchAll Then
                Me.Rows(rowNum).Delete Shift:=xlUp
            End If
        Next rowNum
        
        ' –û–±–Ω–æ–≤–ª—è–µ–º lastRow –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç—Ä–æ–∫
        lastRow = Me.Cells(Me.Rows.Count, "B").End(xlUp).Row
        If lastRow < 4 Then lastRow = 4
        
        ' --- –ù–û–í–´–ô –ë–õ–û–ö: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ü–≤–µ—Ç–∞ —Ñ–æ–Ω–∞ –∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∞ –≥—Ä–∞–Ω–∏—Ü ---
        Dim borderColor As Long
        Dim highlightColor As Long
        
        highlightColor = RGB(255, 255, 153) ' <-- –ñ—ë–ª—Ç—ã–π —Ñ–æ–Ω (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π)
        borderColor = RGB(255, 0, 0)        ' <-- –ö—Ä–∞—Å–Ω—ã–µ –≥—Ä–∞–Ω–∏—Ü—ã (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Å–≤–æ–π)
        
        For Each cell In checkRange
            If cell.Interior.Color = highlightColor Then
                With cell.Borders
                    .LineStyle = xlContinuous
                    .Color = borderColor
                    .Weight = xlThin
                End With
            Else
                cell.Borders.LineStyle = xlNone
            End If
        Next cell
        ' --- –∫–æ–Ω–µ—Ü –±–ª–æ–∫–∞ ---
        
        ' –í—ã—Ä–∞–≤–Ω–∏–≤–∞–Ω–∏–µ —Ç–µ–∫—Å—Ç–∞ –ø–æ —Ü–µ–Ω—Ç—Ä—É –≤–æ –≤—Å–µ–º –¥–∏–∞–ø–∞–∑–æ–Ω–µ B:M
        Me.Range("B4:M" & lastRow).HorizontalAlignment = xlCenter
        Me.Range("B4:M" & lastRow).VerticalAlignment = xlCenter
        
        ' –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –ø–æ–¥–≥–æ–Ω–∫–∞ —à–∏—Ä–∏–Ω—ã —Å—Ç–æ–ª–±—Ü–æ–≤
        Me.Columns("B:M").AutoFit
        
        ' –í–∫–ª—é—á–∞–µ–º –∞–≤—Ç–æ—Ñ–∏–ª—å—Ç—Ä—ã –Ω–∞ 3-–π —Å—Ç—Ä–æ–∫–µ (–µ—Å–ª–∏ –≤–¥—Ä—É–≥ —É–±—Ä–∞–ª–∏—Å—å)
        If Not Me.AutoFilterMode Then
            Me.Range("B3:M3").AutoFilter
        End If
        
        Application.EnableEvents = True
    End If
End Sub


–ø–µ—Ä–µ–¥ –∑–∞–∫—Ä—ã—Ç–∏–µ–º –æ—á–∏—Å—Ç—É–≤

Private Sub Workbook_BeforeClose(Cancel As Boolean)
    Dim ws As Worksheet
    
    On Error Resume Next
    Set ws = ThisWorkbook.Sheets("fromCRM")
    On Error GoTo 0
    
    If ws Is Nothing Then Exit Sub ' –ï—Å–ª–∏ –ª–∏—Å—Ç–∞ –Ω–µ—Ç ‚Äî –≤—ã—Ö–æ–¥–∏–º
    
    ' –°–Ω–∏–º–∞–µ–º –≤—Å–µ —Ñ–∏–ª—å—Ç—Ä—ã
    If ws.AutoFilterMode Then ws.AutoFilterMode = False
    
    ' –í—ã–∑—ã–≤–∞–µ–º —Ç–≤–æ—é –ø—Ä–æ—Ü–µ–¥—É—Ä—É –æ—á–∏—Å—Ç–∫–∏
    ClearAndReset
End Sub


–æ—á–∏—Å—Ç–∫–∞ 
Public Sub ClearAndReset()
    Dim ws As Worksheet
    Dim col As Long
    Dim lastRow As Long
    Dim rng As Range
    
    Set ws = ThisWorkbook.Sheets("fromCRM")
    
    Application.ScreenUpdating = False
    Application.EnableEvents = False
    
    ' –û–ø—Ä–µ–¥–µ–ª—è–µ–º –ø–æ—Å–ª–µ–¥–Ω—é—é –∑–∞–ø–æ–ª–Ω–µ–Ω–Ω—É—é —Å—Ç—Ä–æ–∫—É –ø–æ –≤—Å–µ–º—É –¥–∏–∞–ø–∞–∑–æ–Ω—É B:N
    With ws
        lastRow = 4
        For col = 2 To 14 ' B=2 ... N=14
            If .Cells(.Rows.Count, col).End(xlUp).Row > lastRow Then
                lastRow = .Cells(.Rows.Count, col).End(xlUp).Row
            End If
        Next col
        
        ' –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–µ—Ç, –æ—Å—Ç–∞—ë–º—Å—è –Ω–∞ —Å—Ç—Ä–æ–∫–µ 4
        If lastRow < 4 Then lastRow = 4
        
        ' –û—á–∏—â–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ
        .Range("B4:N" & lastRow).ClearContents
        
        ' –°–±—Ä–∞—Å—ã–≤–∞–µ–º —à–∏—Ä–∏–Ω—É –∫–æ–ª–æ–Ω–æ–∫ –Ω–∞ —Ç—É, —á—Ç–æ —É —Å—Ç—Ä–æ–∫–∏ 3
        For col = 2 To 14
            .Columns(col).ColumnWidth = .Cells(3, col).ColumnWidth
        Next col
    End With
    
    Application.EnableEvents = True
    Application.ScreenUpdating = True
End Sub
